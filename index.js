(async e=>{let t=require("axios"),a=require("fs").promises,i=require("path");mo=require("moment");let l,n=i.join(__dirname,"delete for new data.json"),o=i.join(__dirname,"delete for new account.json");try{l=require(n),require(o)}catch(r){let s=require("fnbr").Client;try{var c={deviceAuth:require(o)}}catch(d){console.log(`[${mo(new Date).format("DD.MM.YYYY, HH:mm:ss")}] log into your epic games account`),console.log(`[${mo(new Date).format("DD.MM.YYYY, HH:mm:ss")}] go to https://www.epicgames.com/id/api/redirect?clientId=3446cd72694c4a4485d81b77adbb2141&responseType=code`),c={authorizationCode:async e=>s.consoleQuestion(`[${mo(new Date).format("DD.MM.YYYY, HH:mm:ss")}] then copy the code and paste it here: `)}}let m=new s({auth:{...c,killOtherTokens:!1},debug:e=>e});m.on("deviceauth:created",e=>a.writeFile(o,JSON.stringify(e,null,2))),await m.login(),console.log(`[${mo(new Date).format("DD.MM.YYYY, HH:mm:ss")}] downloading profile`),l=(await m.Http.send(!0,"POST",`https://fortnite-public-service-prod11.ol.epicgames.com/fortnite/api/game/v2/profile/${m.user.id}/client/QueryProfile?profileId=athena&rvn=-1`,`bearer ${m.Auth.auths.token}`,{"Content-Type":"application/json"},{})).response,await m.logout(),await a.writeFile(n,JSON.stringify(l,null,2))}console.log(`[${mo(new Date).format("DD.MM.YYYY, HH:mm:ss")}] checking cache folder`);let f=i.join(__dirname,"cache");await a.mkdir(f,{recursive:!0}),console.log(`[${mo(new Date).format("DD.MM.YYYY, HH:mm:ss")}] searching active quests`);let p=Object.values(l.profileChanges[0].profile.items).map(e=>({templateId:e.templateId.split(":")[1].toLowerCase(),reached:e.attributes[Object.keys(e.attributes).find(e=>e.startsWith("completion_"))]||0})).filter(e=>e.templateId.match(/quest_s[0-9]{1,}_milestone.*q\d+$/)).sort((e,t)=>e.templateId>t.templateId?1:e.templateId<t.templateId?-1:0),h=[/q\d+/g,"q00"],u=Array.from(new Set(p.map(e=>e.templateId.replace(...h))));p=Object.fromEntries(u.map(e=>{let t=p.filter(t=>t.templateId.replace(...h)===e).filter((e,t,a)=>e.reached===Math.max(...a.map(e=>e.reached)));return[e,{name:null,reached:t[0].reached,quests:t.map(e=>e.templateId),count:[]},]})),console.log(`[${mo(new Date).format("DD.MM.YYYY, HH:mm:ss")}] downloading file list`);let g=i.join(f,"all_files.json");try{var w=require(g)}catch($){await a.writeFile(g,JSON.stringify(w=(await t("https://fortnitecentral.gmatrixgames.ga/api/v1/assets")).data,null,2))}for(let Y in w=w.filter(e=>u.some(t=>e.toLowerCase().replace(...h).includes(t))),p){let y=Object.keys(p).length,v=Object.keys(p).indexOf(Y);for(let _ of(v%10&&v+1!==y||console.log(`[${mo(new Date).format("DD.MM.YYYY, HH:mm:ss")}] downloading quests ... ${v&&v+1!==y?v:v+1} / ${y}`),p[Y].quests)){let D=w.find(e=>e.toLowerCase().includes(_));if(!D){console.log(_);continue}let H=i.join(f,`${_}.json`);try{var M=require(H)}catch(x){await a.writeFile(H,JSON.stringify(M=(await t(`https://fortnitecentral.gmatrixgames.ga/api/v1/export?lang=en&path=${D.split(".")[0]}`)).data.jsonOutput[0].Properties,null,2))}p[Y].name=M.DisplayName.sourceString,p[Y].count.push(M.Objectives[0].Count)}}(p=Object.values(p).filter(e=>!e.count.includes(e.reached)).map(e=>({id:e.quests.reverse()[0],name:e.name,done:e.reached,next:e.count.join(", "),process:e.reached/e.count[0]}))).sort(function(e,t){return t.process-e.process}),await a.writeFile("output.json",JSON.stringify(p,null,2)),console.log(`[${mo(new Date).format("DD.MM.YYYY, HH:mm:ss")}] starting rendering image`);let j=require("canvas"),b=require("canvas-txt").default,C=Math.sqrt(p.length),I=Math.ceil(C),S=Math.trunc(C);C-S>.5&&(S=I);let q=300,k=200,F=10,O=4,R=10,T=40,L=new j.createCanvas(I*q+(I-1)*F,S*k+(S-1)*F),E=L.getContext("2d"),N=E.createLinearGradient(0,0,0,L.height);for(let P of(N.addColorStop(0,"#09b0ff"),N.addColorStop(1,"#0942b4"),E.fillStyle=N,E.fillRect(0,0,L.width,L.height),Array(p.length).keys())){let z={x:P%I*(q+F),y:Math.trunc(P/I)*(k+F),width:q,height:k};E.fillStyle="#00c3ff",E.fillRect(...Object.values(z)),z={x:z.x+O,y:z.y+O,width:z.width-2*O,height:z.height-2*O},E.fillStyle="#0086e6",E.fillRect(...Object.values(z)),E.fillStyle="white",b.fontSize=21;let A=p[P].name+"\n\nDONE: "+p[P].done+"\n\nNEXT: "+p[P].next;b.drawText(E,A,z.x+R,z.y+R,q-2*R,k-3*R-T+O),z={x:z.x-O+R,y:z.y-O+k-R-T,width:q-2*R,height:T},E.fillStyle="#0065ad",E.fillRect(...Object.values(z));let Q=p[P].next.split(", "),B=z.width/Q.reverse()[0];for(let G of(E.fillStyle="#00c3ff",z.width=p[P].done*B,E.fillRect(...Object.values(z)),Q.slice(0,-1)))E.fillStyle="#0086e6",E.fillRect(z.x+G*B-O/2,z.y,O,z.height)}await a.writeFile("output.png",L.toBuffer()),console.log(`[${mo(new Date).format("DD.MM.YYYY, HH:mm:ss")}] generated & saved image`)})();
